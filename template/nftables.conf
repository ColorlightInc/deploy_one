# Uncomment the include statement here to load the default config sample
# in /etc/nftables for nftables service.

#include "/etc/nftables/main.nft"

# To customize, either edit the samples in /etc/nftables, append further
# commands to the end of this file or overwrite it after first service
# start by calling: 'nft list ruleset >/etc/sysconfig/nftables.conf'.

flush ruleset

table ip nat {
        chain PREROUTING {
                type nat hook prerouting priority dstnat; policy accept;
                fib daddr type local counter packets 95 bytes 4988 jump DOCKER
        }

        chain INPUT {
                type nat hook input priority 100; policy accept;
        }

        chain POSTROUTING {
                type nat hook postrouting priority srcnat; policy accept;
                oifname != "br-clt_one_nw" @nh,96,16 44141 counter packets 10 bytes 624 masquerade
                oifname != "docker0" @nh,96,16 44049 counter packets 0 bytes 0 masquerade
                meta l4proto tcp ip saddr 172.109.0.5 ip daddr 172.109.0.5 tcp dport 3306 counter packets 0 bytes 0 masquerade
                meta l4proto tcp ip saddr 172.109.0.2 ip daddr 172.109.0.2 tcp dport 8443 counter packets 0 bytes 0 masquerade
                meta l4proto tcp ip saddr 172.109.0.2 ip daddr 172.109.0.2 tcp dport 8000 counter packets 0 bytes 0 masquerade
                meta l4proto tcp ip saddr 172.109.0.2 ip daddr 172.109.0.2 tcp dport 4443 counter packets 0 bytes 0 masquerade
        }

        chain OUTPUT {
                type nat hook output priority -100; policy accept;
                @nh,128,8 != 127 fib daddr type local counter packets 0 bytes 0 jump DOCKER
        }

        chain DOCKER {
                iifname "br-clt_one_nw" counter packets 0 bytes 0 return
                iifname "docker0" counter packets 6 bytes 360 return
                iifname != "br-clt_one_nw" meta l4proto tcp tcp dport 3306 counter packets 0 bytes 0 dnat to 172.109.0.5:3306
                iifname != "br-clt_one_nw" meta l4proto tcp tcp dport 8443 counter packets 0 bytes 0 dnat to 172.109.0.2:8443
                iifname != "br-clt_one_nw" meta l4proto tcp tcp dport 80 counter packets 0 bytes 0 dnat to 172.109.0.2:8000
                iifname != "br-clt_one_nw" meta l4proto tcp tcp dport 443 counter packets 15 bytes 780 dnat to 172.109.0.2:4443
        }
}
table ip filter {
        chain INPUT {
                type filter hook input priority filter; policy accept;
        }

        chain FORWARD {
                type filter hook forward priority filter; policy drop;
                counter packets 2226 bytes 2701421 jump DOCKER-USER
                counter packets 2226 bytes 2701421 jump DOCKER-ISOLATION-STAGE-1
                oifname "br-clt_one_nw" ct state related,established counter packets 1879 bytes 219661 accept
                oifname "br-clt_one_nw" counter packets 31 bytes 1740 jump DOCKER
                iifname "br-clt_one_nw" oifname != "br-clt_one_nw" counter packets 316 bytes 2480020 accept
                iifname "br-clt_one_nw" oifname "br-clt_one_nw" counter packets 16 bytes 960 accept
        }

        chain OUTPUT {
                type filter hook output priority filter; policy accept;
        }

        chain DOCKER {
                iifname != "br-clt_one_nw" oifname "br-clt_one_nw" meta l4proto tcp ip daddr 172.109.0.5 tcp dport 3306 counter packets 0 bytes 0 accept
                iifname != "br-clt_one_nw" oifname "br-clt_one_nw" meta l4proto tcp ip daddr 172.109.0.2 tcp dport 8443 counter packets 0 bytes 0 accept
                iifname != "br-clt_one_nw" oifname "br-clt_one_nw" meta l4proto tcp ip daddr 172.109.0.2 tcp dport 8000 counter packets 0 bytes 0 accept
                iifname != "br-clt_one_nw" oifname "br-clt_one_nw" meta l4proto tcp ip daddr 172.109.0.2 tcp dport 4443 counter packets 15 bytes 780 accept
        }

        chain DOCKER-ISOLATION-STAGE-1 {
                iifname "br-clt_one_nw" oifname != "br-clt_one_nw" counter packets 316 bytes 2480020 jump DOCKER-ISOLATION-STAGE-2
        }

        chain DOCKER-ISOLATION-STAGE-2 {
                oifname "br-clt_one_nw" counter packets 0 bytes 0 drop
        }

        chain DOCKER-USER {
                counter packets 2226 bytes 2701421 return
        }
}

